# mcqq Another！

一个通过[鹊桥模组](https://www.curseforge.com/minecraft/mc-mods/queqiao)实现 Minecraft 平台适配器，并提供 QQ <-> MC 消息互通的 AstrBot 插件。

基于 [kterna/astrbot_plugin_mcqq](https://github.com/kterna/astrbot_plugin_mcqq) 二次开发，新增功能：
- ✨ **QQ群与MC双向自动消息转发**（无需唤醒词）
- 🔧 优化路由器初始化机制
- 📝 改善整点广播内容
- 🎨 更友好的配置界面
- 🔄 配置热重载支持（`/mcreload` 命令）

⚠️ **重要提示**：由于 AstrBot Minecraft 适配器的限制，本插件**不支持热重载**，修改配置后请完全重启 AstrBot。详见[已知问题](#已知问题)。

[![GitHub](https://img.shields.io/badge/GitHub-Akiyo--dayo-blue?logo=github)](https://github.com/Akiyo-dayo/astrbot_plugin_mcqq)

## 核心功能

- **QQ群 ↔ MC 自动互通**: 绑定群聊后，QQ群和MC服务器的消息会**自动双向转发**，无需唤醒词！
- **多服务器互通**: 将多个 MC 服务器连接在一起，实现跨服聊天、玩家事件（加入/退出/死亡）同步。
- **MC -> QQ**:
  - 玩家**加入/退出/死亡**事件转发到绑定的 QQ 群。
  - 玩家聊天消息**自动转发**到绑定的 QQ 群。
  - 在游戏内使用 `<唤醒词>qq <消息>` 将消息发送到 QQ 群。
  - 在游戏内使用 `<唤醒词><指令>` 调用 AstrBot 的各项功能（包括 AI 对话）。
- **QQ -> MC**:
  - **新增**：QQ 群消息**自动转发**到绑定的 MC 服务器（无需唤醒词）。
  - 支持图片转发（显示为可点击的URL）。
  - 使用 `/mcsay <消息>` 向所有连接的服务器发送广播。
  - 提供丰富的管理命令（RCON, 广播, 绑定等）。
- **高度可配置**: 支持假人过滤、自定义消息前缀、丰富的广播设置、可配置的消息转发开关等。

---

## 目录

- [重要注意事项](#重要注意事项)
- [安装与配置](#安装与配置)
- [命令列表](#命令列表)
- [常见问题 (FAQ)](#常见问题-faq)
- [已知问题](#已知问题)
- [To-Do 计划](#to-do-计划)
- [更新日志](#更新日志)

---

## 重要注意事项

- **游戏内触发指令**: 本插件的游戏内命令依赖 AstrBot 的唤醒词判定。请在 AstrBot「平台配置 → 唤醒词」中为 Minecraft 单独添加一个不会与原版 `/` 指令冲突的前缀（推荐 `#`）。只有以唤醒词开头的聊天才会触发 `qq`、`wiki` 等特殊命令；未配置唤醒词会导致这类命令被忽略。
- **自动消息转发**: QQ群普通消息会自动转发到MC，无需唤醒词。可在插件配置中关闭此功能。
- **RCON 限制**: RCON 功能目前仅对**第一个**配置的服务器适配器生效。
- **配置重载**: 大部分配置修改之后需要完全重启astrbot后才能生效，若出现"为什么修改之后连不上""修改之后无法触发指令"等情况请先重启astrbot试试。
- **版本更新**: 插件更新后，若适配器配置页面未出现新增的配置项，请**删除旧的适配器并重新创建**。
- **互通前提**: 多服务器互通功能需要所有服务器都安装[鹊桥模组](https://www.curseforge.com/minecraft/mc-mods/queqiao)或其 MCDR 移植版。
- **MCDR 特有功能**: `<唤醒词>mc玩家列表` 等部分高级功能仅在使用[鹊桥的 MCDR 移植版](https://github.com/kterna/queqiao_mcdr)时可用。

## 命令触发机制

- MC 聊天被包装成 AstrBot 事件后，会按照唤醒词判定是否继续下发到命令处理器。插件注册了 `qq`、`wiki`、`help`、`landmark` 等前缀命令，由 AstrBot 的过滤器按唤醒词过滤后调用。
- 例如，当唤醒词设置为 `#` 时，在游戏里输入 `#qq 早上好` 会先通过唤醒判定，再由插件的 `QQCommand` 接管，最终把消息转发至绑定的 QQ 群。
- 若需要自定义唤醒词（如 `!` 或 `bot.`），可在 AstrBot 配置中修改。只要玩家输入的消息以该唤醒词开头，对应的 MCQQ 命令就会生效。
- **新增**：普通聊天（不带唤醒词）会自动转发到绑定的QQ群，QQ群的消息也会自动转发到MC，实现真正的无缝互通。

## 安装与配置

### 1. 环境要求

- **AstrBot**: 已安装并运行 AstrBot 框架。
- **Minecraft 服务器**:
  - 安装[鹊桥模组 (Queqiao)](https://www.curseforge.com/minecraft/mc-mods/queqiao)
  - 或安装[鹊桥的 MCDR 移植版](https://github.com/kterna/queqiao_mcdr)

### 2. 插件安装

- 将 `astrbot_plugin_mcqq` 文件夹放置到 AstrBot 的 `data/plugins` 目录下。
- 在 Astrbot 的插件市场中安装。

### 3. 鹊桥模组配置

确保鹊桥模组的 `config.yml` (或 MCDR 的 `config.json`) 配置正确，插件需要读取其中的信息。

**示例 `config.yml`:**
```yaml
server_name: "MyServer-1"  # 必须与插件适配器配置中的 SERVER_NAME 一致
access_token: "your_secure_token" # 建议设置, 并填入插件配置的 AUTHORIZATION
websocket:
  host: "127.0.0.1"
  port: 8080
```

### 4. 适配器配置

1.  在 AstrBot 的 **平台适配器** 设置中，新增 **Minecraft服务器适配器**。
2.  填写以下配置项：

- `adapter_id`: 适配器的唯一标识，例如 `mc_server_1`。
- `ws_url`: 鹊桥模组的 WebSocket 地址，例如 `ws://127.0.0.1:8080/minecraft/ws`。
- `server_name`: 服务器名称，**必须**与鹊桥模组配置中的 `server_name` 完全一致。
- `Authorization`: 访问令牌，如果鹊桥配置了 `access_token` 则必须填写。
- `enable_join_quit_messages`: (true/false) 是否转发玩家加入/退出消息。
- `qq_message_prefix`: 转发到 QQ 消息的前缀，例如 `[MC] `。
- `max_reconnect_retries`: 连接断开后最大重试次数（默认 5）。
- `reconnect_interval`: 重连间隔秒数（默认 3）。
- `filter_bots`: (true/false) 是否开启假人消息过滤。
- `bot_prefix`: 假人名称前缀列表，例如 `["bot_", "robot-"]`。
- `bot_suffix`: 假人名称后缀列表。
- `rcon_enabled`: (true/false) 是否启用 RCON 功能。
- `rcon_host`: RCON 地址。
- `rcon_port`: RCON 端口。
- `rcon_password`: RCON 密码 (必填)。

### 5. 绑定群聊

在需要接收 MC 消息的 QQ 群内，发送 `mcbind` 命令，将该群与主服务器绑定。

---

## 命令列表

### QQ 群命令

- `mcbind [服务器ID]`
  - **功能**: 绑定当前群聊与指定 MC 服务器。不指定服务器ID则绑定到主服务器。
  - **权限**: 管理员

- `mcunbind [服务器ID]`
  - **功能**: 解除当前群聊与指定 MC 服务器的绑定。
  - **权限**: 管理员

- `mcstatus`
  - **功能**: 查看所有 MC 适配器的连接状态和当前群聊的绑定信息。

- `mcsay <消息>`
  - **功能**: 向所有已连接的 MC 服务器发送消息（支持图片），暂不支持cq表情。

- `rcon <指令>`
  - **功能**: 通过 RCON 在**主服务器**上执行指令。
  - **权限**: 管理员

- `rcon 重启`
  - **功能**: 尝试重新连接**主服务器**的 RCON 服务。
  - **权限**: 管理员

- `mc广播设置 <适配器ID> <配置>`
  - **功能**: 为指定服务器设置整点广播内容（支持富文本）。
  - **权限**: 管理员

- `mc广播开关`
  - **功能**: 全局开启或关闭所有服务器的整点广播。
  - **权限**: 管理员

- `mc广播测试`
  - **功能**: 立即触发一次整点广播进行测试。
  - **权限**: 管理员

- `mc自定义广播 <文本>|<点击命令>|<悬浮文本>`
  - **功能**: 向所有绑定的服务器发送富文本自定义广播。
  - **权限**: 管理员

- `mc帮助`
  - **功能**: 查看所有可用的 MC 相关命令及其说明。

- `mcreload` ✨ **新增**
  - **功能**: 重新加载插件配置（从 WebUI 修改配置后使用此命令立即生效）。
  - **说明**: 无需重启 AstrBot，可立即应用配置更改。
  - **权限**: 所有用户

  - **功能**: 向所有服务器发送自定义的富文本广播。
  - **权限**: 管理员

- `mc帮助`
  - **功能**: 显示本帮助信息。

- `mc玩家列表`
  - **功能**: 获取服务器在线玩家列表。
  - **注意**: 此功能仅在使用[鹊桥的 MCDR 移植版](https://github.com/kterna/queqiao_mcdr)时可用，原版鹊桥模组不支持此API。

### Minecraft 游戏内命令

- `<唤醒词>qq <消息>`
  - **功能**: 将消息发送到所有绑定的 QQ 群。

- `<唤醒词><AstrBot 指令>`
  - **功能**: 调用 AstrBot 的核心功能，例如设置唤醒词为 `#` 时，可输入 `#help` 或 `#你好` 与 AI 对话。

- `<唤醒词>wiki <词条>`
  - **功能**: 查询 Minecraft Wiki。

---

## 常见问题 (FAQ)

**Q: 为什么 `rcon` 命令没反应或提示失败？**
**A:** 请检查以下几点：
  1.  你是否是 AstrBot 管理员。
  2.  主服务器（第一个适配器）的 RCON 配置是否已启用并正确填写。
  3.  MC 服务器的 `server.properties` 文件中是否已启用 RCON。
  4.  服务器防火墙是否已放行 RCON 端口。
  5.  该功能目前只对第一个配置的服务器生效。

**Q: 连接状态显示"未连接"怎么办？**
**A:** 请检查：
  1.  MC 服务器及鹊桥模组是否正在运行。
  2.  插件适配器配置中的 `ws_url`, `server_name`, `Authorization` 是否与鹊桥的配置完全一致。
  3.  服务器防火墙是否已放行 WebSocket 端口。
  4.  尝试在 QQ 使用 `mcstatus` 命令，它会自动触发一次重连。

**Q: 修改 WebUI 配置后为什么不生效？**
**A:** 有两种方式使配置生效：
  1. **推荐方式**：在 QQ 群中发送 `/mcreload` 命令，立即重新加载配置，无需重启。
  2. 完全重启 AstrBot（不推荐，耗时较长）。

**Q: 修改适配器配置（ws_url、server_name等）后为什么不生效？** ⚠️
**A:** **适配器配置是特殊的**，修改后必须完全重启 AstrBot 才能生效。这是因为：
  - 适配器在 AstrBot 启动时初始化，插件热重载无法重新创建适配器。
  - 如果只是热重载插件，将无法找到 Minecraft 适配器实例。
  - **建议**：适配器配置一次性设置正确后就不要频繁修改。

**Q: 为什么玩家进入/退出游戏的消息没有发送到QQ群？**
**A:** 请检查：
  1. 该QQ群是否已经通过 `/mcbind` 绑定了MC服务器。
  2. WebUI 配置中的 `enable_join_quit_messages` 是否为 `true`。
  3. 修改配置后是否执行了 `/mcreload` 命令。
  4. 玩家名称是否被假人过滤器过滤（检查 `bot_prefix` 和 `bot_suffix` 配置）。

**Q: `mc玩家列表` 命令提示"请求失败"或没有响应？**
**A:** 请检查以下几点：
  1.  确保你使用的是[鹊桥的 MCDR 移植版](https://github.com/kterna/queqiao_mcdr)，原版鹊桥模组不支持此API。
  2.  MCDR 移植版是否已正确加载并运行。
  3.  服务器连接状态是否正常（可通过 `mcstatus` 查看）。
  4.  MCDR 插件配置是否正确。

---

## 已知问题

⚠️ **以下问题目前暂无法完美解决，请知悉：**

1. **AstrBot WebUI 配置修改无法生效**
   - **现象**：在 WebUI 中修改插件配置后，即使热重载插件，配置也不会立即生效
   - **临时解决方案**：在 QQ 群中发送 `/mcreload` 命令手动重新加载配置
   - **根本解决方案**：完全重启 AstrBot
   - **原因**：配置系统在插件初始化时读取，热重载不会触发重新读取

2. **插件无法热重载（该问题可能无法解决）**
   - **现象**：热重载插件后，提示"无法找到 Minecraft 适配器"，所有功能失效
   - **解决方案**：必须完全重启 AstrBot
   - **原因**：这是 AstrBot 中 Minecraft 适配器的 BUG 导致的。Minecraft 适配器自身无法热重载，重载插件时适配器实例已被销毁但无法重新创建
   - **建议**：配置好插件后尽量避免热重载，需要修改配置时直接重启 AstrBot

---

## To-Do 计划

📋 **未来开发计划：**

- [ ] **重写玩家列表功能**
  - 计划实现无需依赖 MCDR 版本鹊桥 API 的玩家列表查询
  - 目标：让原版鹊桥模组也能支持玩家列表查询功能
  - 状态：规划中

- [ ] **改进适配器热重载支持**
  - 尝试寻找 AstrBot 适配器热重载的解决方案
  - 状态：研究中（可能受限于 AstrBot 框架本身）

---

## 更新日志

### v1.9.0 (Akiyo-dayo Fork)

**新增功能**：
- ✨ **QQ群 → MC 自动消息转发**：绑定群聊后，QQ群消息会自动转发到MC服务器，无需唤醒词
- 🖼️ **图片支持**：QQ群发送的图片会作为可点击的URL显示在MC中
- ⚙️ **配置选项**：新增 `enable_qq_to_mc_forward` 和 `enable_join_quit_messages` 配置项
- 🎨 **消息颜色自定义**：可配置QQ消息在MC中的显示颜色
- 🔄 **配置重载命令**：新增 `/mcreload` 命令，可在不重启的情况下重新加载配置

**优化改进**：
- 🔧 **路由器初始化优化**：改用主动轮询机制，解决适配器初始化时序问题
- 📝 **整点广播优化**：改善默认广播内容，更加正式专业
- 🐛 **修复事件名称匹配**：修复玩家进入/退出/死亡消息无法转发到QQ的问题
- 📊 **日志优化**：关键初始化步骤使用表情符号标识，更易于调试
- ⚡ **事件处理优化**：简化消息转发逻辑，提高性能

**已知问题**：
- ⚠️ WebUI 配置修改需要执行 `/mcreload` 或重启 AstrBot 才能生效
- ⚠️ 插件热重载功能不可用，必须重启 AstrBot（受限于 Minecraft 适配器）

**Bug修复**：
- 🐛 修复配置文件格式错误导致插件加载失败的问题
- 🐛 修复路由器未设置的警告日志问题

---

### 上游版本历史 (kterna)

- **v1.8.2**: 增加mcsay对qq图片的支持
- **v1.8.1**: 修复mcsay发送数据格式错误问题
- **v1.8.0**: 对astrbotv4.0.0+进行适配，修复几个bug。
- **v1.7.4**: 优化消息处理流程。
- **v1.7.3**: 修复bug
- **v1.7.2**: 增加了过滤格式化代码
- **v1.7.1**: 增加mcdr特定指令，修改readme。
- **v1.7.0**: 增加了对 MCDR 的支持。
- **v1.6.2**: 重构了部分代码。
- **v1.6.1**: 增加多服务器分别设置广播内容功能，修改广播数据结构。
- **v1.6.0**: 增加多服务器互通功能。
- **v1.5.1**: 修复bug，注册命令更简单、可维护。
- **v1.5.0**: 增加wiki查询，增加整点广播支持富文本内容。
- **v1.4.0**: 增加rcon命令。
- **v1.3.0**: 增加了minecraft平台适配器。
- **v1.0.0**: 发布测试版本。

## 许可证

本项目采用 MIT 许可证。
